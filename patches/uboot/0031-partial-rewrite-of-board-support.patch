From 242e6e5321c1409bc373d8cf57cac52bc002df4d Mon Sep 17 00:00:00 2001
From: Josua Mayer <josua@solid-run.com>
Date: Mon, 3 Jul 2023 12:38:44 +0200
Subject: [PATCH] partial rewrite of board support

- support distro-boot
- support environment storage

Signed-off-by: Josua Mayer <josua@solid-run.com>
---
 arch/arm/dts/am642-solidrun-u-boot.dtsi       |  22 +-
 arch/arm/dts/am642-solidrun.dts               | 250 +++++++++++++-----
 .../solidrun/am64x_solidrun/am64x_solidrun.c  |  12 +
 configs/am64x_a53_solidrun_defconfig          |  69 ++---
 configs/am64x_r5_solidrun_defconfig           |  33 ++-
 include/configs/am64x_solidrun.h              | 183 +++++++------
 6 files changed, 356 insertions(+), 213 deletions(-)

diff --git a/arch/arm/dts/am642-solidrun-u-boot.dtsi b/arch/arm/dts/am642-solidrun-u-boot.dtsi
index 9e3bf23405..ad8fcaf61b 100644
--- a/arch/arm/dts/am642-solidrun-u-boot.dtsi
+++ b/arch/arm/dts/am642-solidrun-u-boot.dtsi
@@ -8,10 +8,6 @@
 		stdout-path = "serial2:115200n8";
 		tick-timer = &timer1;
 	};
-
-	aliases {
-		ethernet0 = &cpsw3g;
-	};
 };
 
 &cbass_main{
@@ -20,7 +16,7 @@
 		compatible = "ti,omap5430-timer";
 		reg = <0x0 0x2400000 0x0 0x80>;
 		ti,timer-alwon;
-		clock-frequency = <25000000>;
+		clock-frequency = <200000000>;
 		u-boot,dm-spl;
 	};
 };
@@ -40,10 +36,6 @@
 	u-boot,dm-spl;
 };
 
-&ethernet_phy_pins_default {
-	u-boot,dm-spl;
-};
-
 &main_i2c0 {
 	u-boot,dm-spl;
 };
@@ -56,18 +48,6 @@
 	u-boot,dm-spl;
 };
 
-&usb0 {
-	u-boot,dm-spl;
-};
-
-&usbss0 {
-	u-boot,dm-spl;
-};
-
-&main_usb0_pins_default {
-	u-boot,dm-spl;
-};
-
 &dmss {
 	u-boot,dm-spl;
 };
diff --git a/arch/arm/dts/am642-solidrun.dts b/arch/arm/dts/am642-solidrun.dts
index 57b8480ddf..479c9b257f 100644
--- a/arch/arm/dts/am642-solidrun.dts
+++ b/arch/arm/dts/am642-solidrun.dts
@@ -52,6 +52,85 @@
 	};
 };
 
+&cpsw3g {
+	status = "okay";
+	pinctrl-names = "default";
+	pinctrl-0 = <&rgmii1_pins_default>, <&mdio0_pins_default>, <&pru1_mdio0_pins_default>;
+};
+
+&cpsw_port1 {
+	status = "okay";
+	phy-mode = "rgmii-rxid";
+	phy-handle = <&ethernet_phy0>;
+};
+
+&cpsw_port2 {
+	status = "disabled";
+};
+
+&cpsw3g_mdio {
+	status = "okay";
+	pinctrl-names = "default";
+
+	/* SoM */
+	ethernet_phy0: dp83869@0 {
+		status = "okay";
+		//compatible = "ethernet-phy-id2000.a0f1";
+		reg = <0>;
+		ti,clk-output-sel = <DP83867_CLK_O_SEL_REF_CLK>;
+		//ti,op-mode = <DP83869_RGMII_COPPER_ETHERNET>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&ethernet_phy0_pins_default>;
+		/*
+		 * Disable interrupts because ISR never clears 0x0040
+		 *
+		 * interrupt-parent = <&main_gpio1>;
+		 * interrupts = <70 IRQ_TYPE_LEVEL_LOW>;
+		 */
+		/*
+		 * Disable HW Reset because clock signal is daisy-chained
+		 *
+		 * reset-gpios = <&main_gpio0 84 GPIO_ACTIVE_LOW>;
+		 * reset-assert-us = <1>;
+		 * reset-deassert-us = <30>;
+		 */
+	};
+};
+
+&main_gpio0 {
+	status = "disabled";
+};
+
+&main_gpio1 {
+	status = "disabled";
+};
+
+&main_i2c0 {
+	status = "okay";
+	pinctrl-names = "default";
+	pinctrl-0 = <&main_i2c0_pins_default>;
+
+	/* SoM */
+	som_eeprom: eeprom@50 {
+		status = "okay";
+		compatible = "atmel,24c01a";
+		reg = <0x50>;
+		pagesize = <8>;
+	};
+};
+
+&main_i2c1 {
+	status = "disabled";
+};
+
+&main_i2c2 {
+	status = "disabled";
+};
+
+&main_i2c3 {
+	status = "disabled";
+};
+
 &main_pmx0 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&ethernet_phy_pins_default>;
@@ -62,8 +141,38 @@
 			AM64X_IOPAD(0x0278, PIN_INPUT, 7)	/* Pad EXTINTn Mux GPIO1_70 */
 			/* reference clock */
 			AM64X_IOPAD(0x0274, PIN_OUTPUT, 5)	/* Pad EXT_REFCLK1 Mux CLKOUT0 */
-			/* phy@0 reset */
+		>;
+	};
+
+	ethernet_phy0_pins_default: ethernet-phy0-pins-default {
+		pinctrl-single,pins = <
+			/* reset */
 			AM64X_IOPAD(0x0154, PIN_OUTPUT, 7)	/* Pad PRG1_PRU1_GPO19 Mux GPIO0_84 */
+			/* reference clock */
+			AM64X_IOPAD(0x0274, PIN_OUTPUT, 5)	/* Pad EXT_REFCLK1 Mux CLKOUT0 */
+		>;
+	};
+
+	ethernet_phy1_pins_default: ethernet-phy1-pins-default {
+		pinctrl-single,pins = <
+			/* reset */
+			AM64X_IOPAD(0x0150, PIN_OUTPUT, 7)	/* Pad PRG1_PRU1_GPO18 Mux GPIO0_20 */
+			/* led0, external pull-down on SoM */
+			AM64X_IOPAD(0x0128, PIN_INPUT, 7)	/* Pad PRG1_PRU1_GPO8 Mux GPIO0_73 */
+			/* led1/rxer */
+			AM64X_IOPAD(0x011c, PIN_INPUT, 7)	/* Pad PRG1_PRU1_GPO5 Mux GPIO0_70 */
+		>;
+	};
+
+	ethernet_phy2_pins_default: ethernet-phy2-pins-default {
+		pinctrl-single,pins = <
+			/* reset */
+			AM64X_IOPAD(0x00d4, PIN_OUTPUT, 7)	/* Pad PRG1_PRU0_GPO7 Mux GPIO0_52 */
+
+			/* led0, external pull-down on SoM */
+			AM64X_IOPAD(0x00d8, PIN_INPUT, 7)	/* Pad PRG1_PRU0_GPO8 Mux GPIO0_53 */
+			/* led1/rxer */
+			AM64X_IOPAD(0x00cc, PIN_INPUT, 7)	/* Pad PRG1_PRU0_GPO5 Mux GPIO0_50 */
 		>;
 	};
 
@@ -81,34 +190,71 @@
 		>;
 	};
 
-	main_uart0_pins_default: main-uart0-pins-default {
+	main_i2c0_pins_default: main-i2c0-pins-default {
 		pinctrl-single,pins = <
-			AM64X_IOPAD(0x0230, PIN_INPUT, 0)	/* Pad UART0_RXD Mux UART0_RXD */
-			AM64X_IOPAD(0x0234, PIN_OUTPUT, 0)	/* Pad UART0_TXD Mux UART0_TXD */
+			/* external pull-up on SoM */
+			AM64X_IOPAD(0x0260, PIN_INPUT, 0)	/* Pad I2C0_SCL Mux I2C0_SCL */
+			AM64X_IOPAD(0x0264, PIN_INPUT, 0)	/* Pad I2C0_SDA Mux I2C0_SDA */
 		>;
 	};
 
-	main_i2c0_pins_default: main-i2c0-pins-default {
+	/*
+	 * main_mmc0_pins_default: main-mmc0-pins-default
+	 *
+	 * MMC0_CMD: no padconfig
+	 * MMC0_CLK: no padconfig, external pull-up on SoM
+	 * MMC0_DAT0: no padconfig
+	 * MMC0_DAT1: no padconfig
+	 * MMC0_DAT2: no padconfig
+	 * MMC0_DAT3: no padconfig
+	 * MMC0_DAT4: no padconfig
+	 * MMC0_DAT5: no padconfig
+	 * MMC0_DAT6: no padconfig
+	 * MMC0_DAT7: no padconfig
+	 * MMC0_DS: no padconfig, external pull-down on SoM
+	 */
+
+	main_mmc1_pins_default: main-mmc1-pins-default {
 		pinctrl-single,pins = <
-			AM64X_IOPAD(0x0260, PIN_INPUT, 0)	/* Pad I2C0_SCL Mux I2C0_SCL */
-			AM64X_IOPAD(0x0264, PIN_INPUT, 0)	/* Pad I2C0_SDA Mux I2C0_SDA */
+			AM64X_IOPAD(0x0294, PIN_INPUT_PULLUP, 0)	/* (J19) MMC1_CMD */
+			AM64X_IOPAD(0x028c, PIN_INPUT, 0)			/* Pad MMC1_CLK Mux MMC1_CLK */
+			AM64X_IOPAD(0x0288, PIN_INPUT_PULLUP, 0)	/* Pad MMC1_DAT0 Mux MMC1_DAT0 */
+			AM64X_IOPAD(0x0284, PIN_INPUT_PULLUP, 0)	/* Pad MMC1_DAT1 Mux MMC1_DAT1 */
+			AM64X_IOPAD(0x0280, PIN_INPUT_PULLUP, 0)	/* Pad MMC1_DAT2 Mux MMC1_DAT2 */
+			AM64X_IOPAD(0x027c, PIN_INPUT_PULLUP, 0)	/* Pad MMC1_DAT3 Mux MMC1_DAT3 */
+			/* external pull-down on SoM & Carrier - should be up or DNP */
+			AM64X_IOPAD(0x0298, PIN_INPUT_PULLUP, 0)	/* Pad MMC1_SDCD Mux MMC1_SDCD */
+			AM64X_IOPAD(0x0290, PIN_INPUT, 0)			/* MMC1_CLKLB: Undocumented clock loopback */
+		>;
+	};
+
+	main_uart0_pins_default: main-uart0-pins-default {
+		pinctrl-single,pins = <
+			AM64X_IOPAD(0x0230, PIN_INPUT, 0)	/* Pad UART0_RXD Mux UART0_RXD */
+			AM64X_IOPAD(0x0234, PIN_OUTPUT, 0)	/* Pad UART0_TXD Mux UART0_TXD */
 		>;
 	};
 
 	main_usb0_pins_default: main-usb0-pins-default {
 		pinctrl-single,pins = <
-			AM64X_IOPAD(0x02a8, PIN_OUTPUT, 0) /* (E19) USB0_DRVVBUS */
+			AM64X_IOPAD(0x02a8, PIN_OUTPUT, 0)	/* Pad USB0_DRVVBUS Mux USB0_DRVVBUS */
 		>;
 	};
 
 	mdio0_pins_default: mdio0-pins-default {
 		pinctrl-single,pins = <
-			/* TODO: check pull */
 			AM64X_IOPAD(0x01fc, PIN_OUTPUT, 4)	/* Pad PRG0_PRU1_GPO19 Mux MDIO0_MDC */
 			AM64X_IOPAD(0x01f8, PIN_INPUT, 4)	/* Pad PRG0_PRU1_GPO18 Mux MDIO0_MDIO */
 		>;
 	};
 
+	pru1_mdio0_pins_default: pru1-mdio0-pins-default {
+		pinctrl-single,pins = <
+			AM64X_IOPAD(0x015c, PIN_OUTPUT, 0)	/* Pad PRG1_MDIO0_MDC Mux PRG1_MDIO0_MDC */
+			AM64X_IOPAD(0x0158, PIN_INPUT, 0)	/* Pad PRG1_MDIO0_MDIO Mux PRG1_MDIO0_MDIO */
+		>;
+	};
+
 	rgmii1_pins_default: rgmii1-pins-default {
 		pinctrl-single,pins = <
 			AM64X_IOPAD(0x01cc, PIN_INPUT, 4)	/* Pad PRG0_PRU1_GPO7 Mux RGMII1_RD0 */
@@ -127,14 +273,35 @@
 	};
 };
 
+&main_spi0 {
+	status = "disabled";
+};
+
+&main_spi1 {
+	status = "disabled";
+};
+
+&main_spi2 {
+	status = "disabled";
+};
+
+&main_spi3 {
+	status = "disabled";
+};
+
+&main_spi4 {
+	status = "disabled";
+};
+
+/* Cortex-A53 console*/
 &main_uart0 {
+	status = "okay";
 	pinctrl-names = "default";
 	pinctrl-0 = <&main_uart0_pins_default>;
 };
 
-/* main_uart1 is reserved for firmware usage */
 &main_uart1 {
-	status = "reserved";
+	status = "disabled";
 };
 
 &main_uart2 {
@@ -157,48 +324,36 @@
 	status = "disabled";
 };
 
-&mcu_uart0 {
+&mcu_i2c0 {
 	status = "disabled";
 };
 
-&mcu_uart1 {
+&mcu_i2c1 {
 	status = "disabled";
 };
 
-&main_i2c0 {
-	pinctrl-names = "default";
-	pinctrl-0 = <&main_i2c0_pins_default>;
-	clock-frequency = <400000>;
-	status = "okay";
-
-	som_eeprom: eeprom@50 {
-		status = "okay";
-		compatible = "atmel,24c01a";
-		reg = <0x50>;
-		pagesize = <8>;
-	};
-};
-
-&main_i2c1 {
+&mcu_spi0 {
 	status = "disabled";
 };
 
-&mcu_i2c0 {
+&mcu_spi1 {
 	status = "disabled";
 };
 
-&mcu_i2c1 {
+&mcu_uart0 {
 	status = "disabled";
 };
 
-&mcu_spi0 {
+&mcu_uart1 {
 	status = "disabled";
 };
 
-&mcu_spi1 {
+&ospi0 {
 	status = "disabled";
 };
 
+/* eMMC */
+/* SoM */
 &sdhci0 {
 	status = "okay";
 	/* mmc0 pins have no padconfig */
@@ -218,6 +373,8 @@
 	vqmmc-supply = <&vdd_mmc0>;
 };
 
+/* microSD connector */
+/* Carrier */
 &sdhci1 {
 	status = "okay";
 	pinctrl-names = "default";
@@ -240,32 +397,3 @@
 	pinctrl-0 = <&main_usb0_pins_default>;
 	maximum-speed = "high-speed";
 };
-
-&cpsw3g {
-	status = "okay";
-	pinctrl-names = "default";
-	pinctrl-0 = <&mdio0_pins_default>, <&rgmii1_pins_default>;
-};
-
-&cpsw_port1 {
-	status = "okay";
-	phy-mode = "rgmii-rxid";
-	phy-handle = <&ethernet_phy0>;
-};
-
-&cpsw_port2 {
-	status = "disabled";
-};
-
-&cpsw3g_mdio {
-	status = "okay";
-
-	ethernet_phy0: dp83869@0 {
-		status = "okay";
-		reg = <0>;
-	};
-};
-
-&ospi0 {
-	status = "disabled";
-};
diff --git a/board/solidrun/am64x_solidrun/am64x_solidrun.c b/board/solidrun/am64x_solidrun/am64x_solidrun.c
index 5be4dd129f..a90004bc34 100644
--- a/board/solidrun/am64x_solidrun/am64x_solidrun.c
+++ b/board/solidrun/am64x_solidrun/am64x_solidrun.c
@@ -507,6 +507,18 @@ void spl_board_init(void)
 #endif
 
 
+#if defined(CONFIG_SPL_BUILD) && defined(CONFIG_TI_I2C_BOARD_DETECT)
+/*
+ * Perform HW detection.
+ * On 0-return, board_fit_config_name_match will be called again.
+ */
+int do_board_detect(void)
+{
+	/* TODO: read TLV EEPROM here */
+	return -ENOTSUPP;
+}
+#endif
+
 
 
 #ifndef	CONFIG_SPL_BUILD
diff --git a/configs/am64x_a53_solidrun_defconfig b/configs/am64x_a53_solidrun_defconfig
index 9750868ab6..397b8e2e2b 100644
--- a/configs/am64x_a53_solidrun_defconfig
+++ b/configs/am64x_a53_solidrun_defconfig
@@ -1,16 +1,18 @@
 CONFIG_ARM=y
 CONFIG_ARCH_K3=y
+CONFIG_TI_SECURE_DEVICE=y
+CONFIG_TI_COMMON_CMD_OPTIONS=y
 CONFIG_SPL_GPIO_SUPPORT=y
 CONFIG_SPL_LIBCOMMON_SUPPORT=y
 CONFIG_SPL_LIBGENERIC_SUPPORT=y
 CONFIG_SYS_MALLOC_F_LEN=0x8000
 CONFIG_NR_DRAM_BANKS=2
 CONFIG_SOC_K3_AM642=y
-CONFIG_K3_ATF_LOAD_ADDR=0x701a0000
+CONFIG_K3_ATF_LOAD_ADDR=0x701c0000
 CONFIG_TARGET_AM642_A53_SOLIDRUN=y
 CONFIG_ENV_SIZE=0x20000
-CONFIG_ENV_OFFSET=0x680000
-CONFIG_SYS_SPI_U_BOOT_OFFS=0x280000
+CONFIG_SYS_SPI_U_BOOT_OFFS=0x300000
+CONFIG_DM_GPIO=y
 CONFIG_SPL_DM_SPI=y
 CONFIG_SPL_TEXT_BASE=0x80080000
 CONFIG_SPL_MMC_SUPPORT=y
@@ -24,20 +26,28 @@ CONFIG_SPL_SPI_SUPPORT=y
 CONFIG_DEFAULT_DEVICE_TREE="am642-solidrun"
 CONFIG_DISTRO_DEFAULTS=y
 # CONFIG_SYS_MALLOC_CLEAR_ON_INIT is not set
+CONFIG_FIT_IMAGE_POST_PROCESS=y
 CONFIG_SPL_LOAD_FIT=y
 CONFIG_SPL_LOAD_FIT_ADDRESS=0x81000000
-CONFIG_BOOTCOMMAND="find_dt; run load_kern; run load_fdt; run set_boot_args; run run_kern;"
+CONFIG_SPL_LOAD_FIT_APPLY_OVERLAY=y
+CONFIG_SPL_FIT_IMAGE_POST_PROCESS=y
+CONFIG_DEFAULT_FDT_FILE="am642-solidrun.dtb"
 CONFIG_BOARD_LATE_INIT=y
+CONFIG_SPL_BOARD_INIT=y
 CONFIG_SPL_SYS_MALLOC_SIMPLE=y
 CONFIG_SPL_STACK_R=y
 CONFIG_SPL_SEPARATE_BSS=y
 CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_SECTOR=y
-CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR=0x1000
+CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR=0x1800
 CONFIG_SPL_DMA=y
 CONFIG_SPL_ENV_SUPPORT=y
+CONFIG_SPL_ETH_SUPPORT=y
 CONFIG_SPL_I2C_SUPPORT=y
 CONFIG_SPL_DM_MAILBOX=y
+CONFIG_SPL_MTD_SUPPORT=y
 CONFIG_SPL_DM_SPI_FLASH=y
+CONFIG_SPL_NET_SUPPORT=y
+CONFIG_SPL_NET_VCI_STRING="AM64X U-Boot A53 SPL"
 CONFIG_SPL_POWER_DOMAIN=y
 CONFIG_SPL_RAM_SUPPORT=y
 CONFIG_SPL_RAM_DEVICE=y
@@ -50,39 +60,38 @@ CONFIG_SPL_USB_STORAGE=y
 CONFIG_SPL_USB_GADGET=y
 CONFIG_SPL_DFU=y
 CONFIG_SPL_YMODEM_SUPPORT=y
-CONFIG_CMD_ASKENV=y
-CONFIG_CMD_DFU=y
+CONFIG_CMD_TLV_EEPROM=y
+# CONFIG_CMD_BOOTZ is not set
+# CONFIG_CMD_EEPROM is not set
 CONFIG_CMD_DM=y
-CONFIG_CMD_GPT=y
-CONFIG_CMD_I2C=y
-CONFIG_CMD_MMC=y
+# CONFIG_CMD_GPIO is not set
 CONFIG_CMD_MTD=y
-CONFIG_CMD_USB=y
-CONFIG_CMD_TIME=y
-CONFIG_MTDIDS_DEFAULT="nor0=fc40000.spi.0"
-CONFIG_MTDPARTS_DEFAULT="mtdparts=fc40000.spi.0:512k(ospi.tiboot3),2m(ospi.tispl),4m(ospi.u-boot),256k(ospi.env),256k(ospi.env.backup),57088k@8m(ospi.rootfs),256k(ospi.phypattern)"
+# CONFIG_CMD_SPI is not set
+CONFIG_CMD_DDRSS=y
+# CONFIG_CMD_EXT4_WRITE is not set
+CONFIG_CMD_MTDPARTS=y
 CONFIG_CMD_UBI=y
 CONFIG_OF_CONTROL=y
 CONFIG_SPL_OF_CONTROL=y
-CONFIG_OF_LIST="am642-solidrun"
 CONFIG_MULTI_DTB_FIT=y
 CONFIG_SPL_MULTI_DTB_FIT=y
 CONFIG_SPL_MULTI_DTB_FIT_NO_COMPRESSION=y
-CONFIG_ENV_IS_NOWHERE=y
 CONFIG_ENV_IS_IN_FAT=y
-CONFIG_ENV_FAT_DEVICE_AND_PART="1:1"
+CONFIG_ENV_FAT_DEVICE_AND_PART=":1"
+CONFIG_SYS_MMC_ENV_DEV=1
+CONFIG_SPL_ENV_IS_NOWHERE=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
 CONFIG_SPL_DM=y
 CONFIG_SPL_DM_SEQ_ALIAS=y
 CONFIG_REGMAP=y
-CONFIG_SYSCON=y
 CONFIG_SPL_REGMAP=y
+CONFIG_SYSCON=y
 CONFIG_SPL_OF_TRANSLATE=y
 CONFIG_CLK=y
 CONFIG_SPL_CLK=y
-CONFIG_CLK_TI_SCI=y
 CONFIG_CLK_CCF=y
+CONFIG_CLK_TI_SCI=y
 CONFIG_DFU_MMC=y
 CONFIG_DFU_RAM=y
 CONFIG_DFU_SF=y
@@ -91,11 +100,16 @@ CONFIG_SYS_DFU_MAX_FILE_SIZE=0x800000
 CONFIG_DMA_CHANNELS=y
 CONFIG_TI_K3_NAVSS_UDMA=y
 CONFIG_TI_SCI_PROTOCOL=y
+CONFIG_DM_PCA953X=y
+CONFIG_SPL_DM_PCA953X=y
 CONFIG_DM_I2C=y
+CONFIG_I2C_SET_DEFAULT_BUS_NUM=y
+CONFIG_DM_I2C_GPIO=y
 CONFIG_SYS_I2C_OMAP24XX=y
-CONFIG_DM_GPIO=y
 CONFIG_DM_MAILBOX=y
 CONFIG_K3_SEC_PROXY=y
+CONFIG_TI_GPMC=y
+CONFIG_I2C_EEPROM=y
 CONFIG_DM_MMC=y
 CONFIG_SUPPORT_EMMC_BOOT=y
 CONFIG_MMC_HS400_SUPPORT=y
@@ -119,17 +133,16 @@ CONFIG_SPI_FLASH_MT35XU=y
 CONFIG_SPI_FLASH_MTD=y
 CONFIG_MULTIPLEXER=y
 CONFIG_MUX_MMIO=y
+CONFIG_PHY_TI_DP83867=y
 CONFIG_PHY_FIXED=y
 CONFIG_DM_ETH=y
+CONFIG_DM_ETH_PHY=y
 CONFIG_TI_AM65_CPSW_NUSS=y
 CONFIG_PHY=y
 CONFIG_SPL_PHY=y
 CONFIG_PHY_CADENCE_SIERRA=y
-CONFIG_SPL_PHY_CADENCE_SIERRA=y
 CONFIG_PHY_CADENCE_TORRENT=y
-CONFIG_SPL_PHY_CADENCE_TORRENT=y
 CONFIG_PHY_J721E_WIZ=y
-CONFIG_SPL_PHY_J721E_WIZ=y
 CONFIG_PINCTRL=y
 CONFIG_SPL_PINCTRL=y
 CONFIG_PINCTRL_SINGLE=y
@@ -151,9 +164,10 @@ CONFIG_SYSRESET=y
 CONFIG_SPL_SYSRESET=y
 CONFIG_SYSRESET_TI_SCI=y
 CONFIG_DM_THERMAL=y
+CONFIG_TIMER=y
+CONFIG_OMAP_TIMER=y
 CONFIG_USB=y
 CONFIG_DM_USB=y
-CONFIG_USB_HOST=y
 CONFIG_DM_USB_GADGET=y
 CONFIG_SPL_DM_USB_GADGET=y
 CONFIG_USB_XHCI_HCD=y
@@ -169,10 +183,5 @@ CONFIG_USB_GADGET_PRODUCT_NUM=0x6165
 CONFIG_USB_GADGET_DOWNLOAD=y
 CONFIG_USB_FUNCTION_MASS_STORAGE=y
 CONFIG_FS_FAT_MAX_CLUSTSIZE=16384
-CONFIG_OF_LIBFDT_OVERLAY=y
-CONFIG_TI_I2C_BOARD_DETECT=n
-CONFIG_BOOTDELAY=3
-CONFIG_I2C_EEPROM=y
-CONFIG_CMD_TLV_EEPROM=y
+CONFIG_HEXDUMP=y
 CONFIG_EEPROM_TLV_LIB=y
-CONFIG_CMD_EEPROM=y
diff --git a/configs/am64x_r5_solidrun_defconfig b/configs/am64x_r5_solidrun_defconfig
index a3d8ff451b..cd2d0a4829 100644
--- a/configs/am64x_r5_solidrun_defconfig
+++ b/configs/am64x_r5_solidrun_defconfig
@@ -1,13 +1,15 @@
 CONFIG_ARM=y
 CONFIG_ARCH_K3=y
+CONFIG_TI_SECURE_DEVICE=y
 CONFIG_SPL_GPIO_SUPPORT=y
 CONFIG_SPL_LIBCOMMON_SUPPORT=y
 CONFIG_SPL_LIBGENERIC_SUPPORT=y
 CONFIG_SYS_MALLOC_F_LEN=0x80000
+CONFIG_NR_DRAM_BANKS=2
 CONFIG_SOC_K3_AM642=y
 CONFIG_TARGET_AM642_R5_SOLIDRUN=y
 CONFIG_ENV_SIZE=0x20000
-CONFIG_SYS_SPI_U_BOOT_OFFS=0x80000
+CONFIG_SYS_SPI_U_BOOT_OFFS=0x100000
 CONFIG_DM_GPIO=y
 CONFIG_SPL_DM_SPI=y
 CONFIG_SPL_TEXT_BASE=0x70000000
@@ -24,6 +26,8 @@ CONFIG_SPL_SPI_SUPPORT=y
 CONFIG_DEFAULT_DEVICE_TREE="am64x-solidrun-r5"
 CONFIG_SPL_LOAD_FIT=y
 CONFIG_SPL_LOAD_FIT_ADDRESS=0x80080000
+CONFIG_SPL_LOAD_FIT_APPLY_OVERLAY=y
+CONFIG_SPL_FIT_IMAGE_POST_PROCESS=y
 # CONFIG_DISPLAY_CPUINFO is not set
 CONFIG_SPL_SIZE_LIMIT_SUBTRACT_GD=y
 CONFIG_SPL_SIZE_LIMIT_SUBTRACT_MALLOC=y
@@ -34,12 +38,16 @@ CONFIG_SPL_STACK_R=y
 CONFIG_SPL_SEPARATE_BSS=y
 CONFIG_SPL_EARLY_BSS=y
 CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_SECTOR=y
-CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR=0x400
+CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR=0x800
 CONFIG_SPL_DMA=y
 CONFIG_SPL_ENV_SUPPORT=y
+CONFIG_SPL_ETH_SUPPORT=y
 CONFIG_SPL_I2C_SUPPORT=y
 CONFIG_SPL_DM_MAILBOX=y
+CONFIG_SPL_MTD_SUPPORT=y
 CONFIG_SPL_DM_SPI_FLASH=y
+CONFIG_SPL_NET_SUPPORT=y
+CONFIG_SPL_NET_VCI_STRING="AM64X U-Boot R5 SPL"
 CONFIG_SPL_DM_RESET=y
 CONFIG_SPL_POWER_SUPPORT=y
 CONFIG_SPL_POWER_DOMAIN=y
@@ -64,13 +72,13 @@ CONFIG_CMD_REMOTEPROC=y
 CONFIG_CMD_USB=y
 CONFIG_CMD_USB_MASS_STORAGE=y
 # CONFIG_CMD_SETEXPR is not set
+CONFIG_CMD_DHCP=y
 CONFIG_CMD_TIME=y
 CONFIG_CMD_FAT=y
 CONFIG_OF_CONTROL=y
 CONFIG_SPL_OF_CONTROL=y
 CONFIG_SPL_MULTI_DTB_FIT=y
 CONFIG_SPL_MULTI_DTB_FIT_NO_COMPRESSION=y
-CONFIG_ENV_IS_NOWHERE=y
 CONFIG_SYS_RELOC_GD_ENV_ADDR=y
 CONFIG_DM=y
 CONFIG_SPL_DM=y
@@ -82,6 +90,7 @@ CONFIG_SPL_SYSCON=y
 CONFIG_SPL_OF_TRANSLATE=y
 CONFIG_CLK=y
 CONFIG_SPL_CLK=y
+CONFIG_SPL_CLK_CCF=y
 CONFIG_CLK_TI_SCI=y
 CONFIG_DFU_MMC=y
 CONFIG_DFU_RAM=y
@@ -91,15 +100,20 @@ CONFIG_DMA_CHANNELS=y
 CONFIG_TI_K3_NAVSS_UDMA=y
 CONFIG_TI_SCI_PROTOCOL=y
 CONFIG_DA8XX_GPIO=y
+CONFIG_DM_PCA953X=y
+CONFIG_SPL_DM_PCA953X=y
 CONFIG_DM_I2C=y
 CONFIG_SYS_I2C_OMAP24XX=y
 CONFIG_DM_MAILBOX=y
 CONFIG_K3_SEC_PROXY=y
+CONFIG_TI_GPMC=y
 CONFIG_DM_MMC=y
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_SDHCI_ADMA=y
 CONFIG_SPL_MMC_SDHCI_ADMA=y
 CONFIG_MMC_SDHCI_AM654=y
+CONFIG_MTD=y
+CONFIG_DM_MTD=y
 CONFIG_DM_SPI_FLASH=y
 CONFIG_SF_DEFAULT_MODE=0
 CONFIG_SPI_FLASH_SFDP_SUPPORT=y
@@ -109,6 +123,9 @@ CONFIG_SPI_FLASH_SPANSION=y
 CONFIG_SPI_FLASH_S28HS512T=y
 CONFIG_SPI_FLASH_STMICRO=y
 CONFIG_SPI_FLASH_MT35XU=y
+CONFIG_PHY_TI_DP83867=y
+CONFIG_DM_ETH=y
+CONFIG_TI_AM65_CPSW_NUSS=y
 CONFIG_PINCTRL=y
 # CONFIG_PINCTRL_GENERIC is not set
 CONFIG_SPL_PINCTRL=y
@@ -126,27 +143,30 @@ CONFIG_DM_RESET=y
 CONFIG_RESET_TI_SCI=y
 CONFIG_SPECIFY_CONSOLE_INDEX=y
 CONFIG_DM_SERIAL=y
+CONFIG_SOC_DEVICE=y
+CONFIG_SOC_DEVICE_TI_K3=y
 CONFIG_SOC_TI=y
 CONFIG_SPI=y
 CONFIG_DM_SPI=y
 CONFIG_CADENCE_QSPI=y
 CONFIG_CADENCE_QSPI_PHY=y
+CONFIG_SYSRESET=y
+CONFIG_SPL_SYSRESET=y
+CONFIG_SYSRESET_TI_SCI=y
 CONFIG_DM_THERMAL=y
 CONFIG_TIMER=y
 CONFIG_SPL_TIMER=y
 CONFIG_OMAP_TIMER=y
 CONFIG_USB=y
 CONFIG_DM_USB=y
-CONFIG_SPL_DM_USB=y
 CONFIG_DM_USB_GADGET=y
 CONFIG_SPL_DM_USB_GADGET=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_CDNS3=y
 CONFIG_USB_CDNS3_GADGET=y
-CONFIG_SPL_USB_CDNS3_GADGET=y
 CONFIG_USB_CDNS3_HOST=y
+CONFIG_SPL_USB_CDNS3_GADGET=y
 CONFIG_SPL_USB_CDNS3_HOST=y
-CONFIG_USB_CDNS3_TI=y
 CONFIG_USB_STORAGE=y
 CONFIG_USB_GADGET=y
 CONFIG_USB_GADGET_MANUFACTURER="Texas Instruments"
@@ -154,4 +174,3 @@ CONFIG_USB_GADGET_VENDOR_NUM=0x0451
 CONFIG_USB_GADGET_PRODUCT_NUM=0x6165
 CONFIG_USB_GADGET_DOWNLOAD=y
 CONFIG_FS_FAT_MAX_CLUSTSIZE=16384
-CONFIG_TI_I2C_BOARD_DETECT=n
diff --git a/include/configs/am64x_solidrun.h b/include/configs/am64x_solidrun.h
index eacd53c1d1..af3d469957 100644
--- a/include/configs/am64x_solidrun.h
+++ b/include/configs/am64x_solidrun.h
@@ -1,123 +1,118 @@
 /* SPDX-License-Identifier: GPL-2.0+ */
 /*
- * Configuration header file for K3 AM642 SoC family
+ * Configuration header file for SolidRun AM642 SoM
  *
- * Copyright (C) 2020 Texas Instruments Incorporated - https://www.ti.com/
- *	Keerthy <j-keerthy@ti.com>
+ * Copyright (C) 2023 Josua Mayer <josua@solid-run.com>
  */
 
-#ifndef __CONFIG_AM642_EVM_H
-#define __CONFIG_AM642_EVM_H
+#ifndef __CONFIG_AM642_SOLIDRUN_H
+#define __CONFIG_AM642_SOLIDRUN_H
 
 #include <linux/sizes.h>
 #include <config_distro_bootcmd.h>
-#include <environment/ti/mmc.h>
 #include <asm/arch/am64_hardware.h>
-#include <environment/ti/k3_dfu.h>
-
-/* DDR Configuration */
-#define CONFIG_SYS_SDRAM_BASE1		0x880000000
 
+/* SPL payload filename */
 #ifdef CONFIG_SYS_K3_SPL_ATF
 #define CONFIG_SPL_FS_LOAD_PAYLOAD_NAME	"tispl.bin"
 #endif
 
+/* skip low-level init in full u-boot (a53) after spl (r5) */
 #ifndef CONFIG_CPU_V7R
 #define CONFIG_SKIP_LOWLEVEL_INIT
 #endif
 
-#define CONFIG_SPL_MAX_SIZE		CONFIG_SYS_K3_MAX_DOWNLODABLE_IMAGE_SIZE
-#if defined(CONFIG_TARGET_AM642_A53_SOLIDRUN)
-#define CONFIG_SYS_INIT_SP_ADDR         (CONFIG_SPL_TEXT_BASE +	\
-					CONFIG_SYS_K3_NON_SECURE_MSRAM_SIZE - 4)
-#else
-/*
- * Maximum size in memory allocated to the SPL BSS. Keep it as tight as
- * possible (to allow the build to go through), as this directly affects
- * our memory footprint. The less we use for BSS the more we have available
- * for everything else.
- */
-#define CONFIG_SPL_BSS_MAX_SIZE		0x1000
-/*
- * Link BSS to be within SPL in a dedicated region located near the top of
- * the MCU SRAM, this way making it available also before relocation. Note
- * that we are not using the actual top of the MCU SRAM as there is a memory
- * location filled in by the boot ROM that we want to read out without any
- * interference from the C context.
- */
-#define CONFIG_SPL_BSS_START_ADDR	(TI_SRAM_SCRATCH_BOARD_EEPROM_START -\
-					 CONFIG_SPL_BSS_MAX_SIZE)
-/* Set the stack right below the SPL BSS section */
-#define CONFIG_SYS_INIT_SP_ADDR         CONFIG_SPL_BSS_START_ADDR
-/* Configure R5 SPL post-relocation malloc pool in DDR */
-#define CONFIG_SYS_SPL_MALLOC_START    0x84000000
-#define CONFIG_SYS_SPL_MALLOC_SIZE     SZ_16M
-#endif
+/* DDR Configuration */
+#define CFG_SYS_SDRAM_BASE1 0x880000000
 
-#define PARTS_DEFAULT \
-	/* Linux partitions */ \
-	"name=rootfs,start=0,size=-,uuid=${uuid_gpt_rootfs}\0"
-
-/* U-Boot general configuration */
-#define EXTRA_ENV_AM642_BOARD_SETTINGS					\
-	"name_kern=Image\0"						\
-	"console=ttyS2,115200n8\0"					\
-	"load_kern=load mmc 1:1 ${kernel_addr_r} ${name_kern}\0"	\
-	"load_fdt=load mmc 1:1 ${fdt_addr_r} ${fdtfile}\0"	\
-	"load_rootfs=setenv rd_spec ${ramdisk_addr_r}; load mmc 1:1 ${rd_spec} rootfs.cpio\0"	\
-	"set_boot_args=setenv bootargs console=${console} root=/dev/mmcblk1p2 rw rootwait\0"	\
-	"run_kern=booti ${kernel_addr_r} ${rd_spec} ${fdt_addr_r}\0"
-
-/* U-Boot MMC-specific configuration */
-#define EXTRA_ENV_AM642_BOARD_SETTINGS_MMC				\
-	"boot=mmc\0"							\
-	"mmcdev=1\0"							\
-	"bootpart=1:2\0"						\
-	"bootdir=/boot\0"						\
-	"rd_spec=-\0"							\
-	"init_mmc=run args_all args_mmc\0"				\
-	"get_fdt_mmc=load mmc ${bootpart} ${fdtaddr} ${bootdir}/${fdtfile}\0" \
-	"get_overlay_mmc="						\
-		"fdt address ${fdtaddr};"				\
-		"fdt resize 0x100000;"					\
-		"for overlay in $name_overlays;"			\
-		"do;"							\
-		"load mmc ${bootpart} ${dtboaddr} ${bootdir}/${overlay} && "	\
-		"fdt apply ${dtboaddr};"				\
-		"done;\0"						\
-	"get_kern_mmc=load mmc ${bootpart} ${loadaddr} "		\
-		"${bootdir}/${name_kern}\0"				\
-	"get_fit_mmc=load mmc ${bootpart} ${addr_fit} "			\
-		"${bootdir}/${name_fit}\0"				\
-	"partitions=" PARTS_DEFAULT
+/* SPL size limit */
+#define CONFIG_SPL_MAX_SIZE CONFIG_SYS_K3_MAX_DOWNLODABLE_IMAGE_SIZE
 
-#ifdef CONFIG_TARGET_AM642_A53_SOLIDRUN
-#define EXTRA_ENV_AM642_BOARD_SETTINGS_MTD				\
-	"mtdids=" CONFIG_MTDIDS_DEFAULT "\0"				\
-	"mtdparts=" CONFIG_MTDPARTS_DEFAULT "\0"
-#else
-#define EXTRA_ENV_AM642_BOARD_SETTINGS_MTD
-#endif
+/* special memory layout for R5 */
+#ifdef CONFIG_TARGET_AM642_R5_SOLIDRUN
+#define CONFIG_SYS_INIT_SP_ADDR 0x7019b800
 
+#define CONFIG_SPL_BSS_START_ADDR 0x7019b800
+#define CONFIG_SPL_BSS_MAX_SIZE 0x4000
 
-#define EXTRA_ENV_DFUARGS \
-	DFU_ALT_INFO_MMC \
-	DFU_ALT_INFO_EMMC \
-	DFU_ALT_INFO_RAM \
-	DFU_ALT_INFO_OSPI
+#define CONFIG_SYS_SPL_MALLOC_START 0x84000000
+#define CONFIG_SYS_SPL_MALLOC_SIZE SZ_16M
+#endif
 
-/* Incorporate settings into the U-Boot environment */
-#define CONFIG_EXTRA_ENV_SETTINGS					\
-	DEFAULT_LINUX_BOOT_ENV						\
-	DEFAULT_MMC_TI_ARGS						\
-	EXTRA_ENV_AM642_BOARD_SETTINGS					\
-	EXTRA_ENV_AM642_BOARD_SETTINGS_MMC				\
-	EXTRA_ENV_AM642_BOARD_SETTINGS_MTD				\
-	EXTRA_ENV_DFUARGS
+/* special memory layout for A53 */
+#ifdef CONFIG_TARGET_AM642_A53_SOLIDRUN
+#define CONFIG_SYS_INIT_SP_ADDR 0x80480000
+
+#define CONFIG_SPL_BSS_START_ADDR 0x80a00000
+#define CONFIG_SPL_BSS_MAX_SIZE 0x80000
+#endif
 
 /* Now for the remaining common defines */
 #include <configs/ti_armv7_common.h>
 
+/* For loading SPL from USB, choose fat boot partition number. */
 #define CONFIG_SYS_USB_FAT_BOOT_PARTITION 1
 
-#endif /* __CONFIG_AM642_EVM_H */
+#ifndef CONFIG_SYS_LOAD_ADDR
+/* load addresses (not distro-boot, falcon mode e.g.) */
+#define CONFIG_SYS_LOAD_ADDR 0x82000000
+#endif
+
+#define SCRIPT_ADDR_R		__stringify(0x82000000)
+#define PXEFILE_ADDR_R		__stringify(0x82100000)
+#define FDT_ADDR_R			__stringify(0x82300000)
+#define KERNEL_ADDR_R		__stringify(0x82400000)
+#define KERNEL_COMP_ADDR_R	__stringify(0x86400000)
+#define KERNEL_COMP_SIZE	__stringify(0x01b00000)
+#define RAMDISK_ADDR_R		__stringify(0x88000000)
+
+/* Boot Targets */
+
+#ifdef CONFIG_CMD_MMC
+#define BOOT_TARGET_DEVICES_MMC(func) func(MMC, mmc, 0) func(MMC, mmc, 1)
+#else
+#define BOOT_TARGET_DEVICES_MMC(func)
+#endif
+
+#ifdef CONFIG_USB_STORAGE
+#define BOOT_TARGET_DEVICES_USB(func) func(USB, usb, 0)
+#else
+#define BOOT_TARGET_DEVICES_USB(func)
+#endif
+
+#ifdef CONFIG_CMD_PXE
+#define BOOT_TARGET_DEVICES_PXE(func) func(PXE, pxe, na)
+#else
+#define BOOT_TARGET_DEVICES_PXE(func)
+#endif
+
+#ifdef CONFIG_CMD_DHCP
+#define BOOT_TARGET_DEVICES_DHCP(func) func(DHCP, dhcp, na)
+#else
+#define BOOT_TARGET_DEVICES_DHCP(func)
+#endif
+
+#define BOOT_TARGET_DEVICES(func) \
+        BOOT_TARGET_DEVICES_MMC(func) \
+        BOOT_TARGET_DEVICES_USB(func) \
+        BOOT_TARGET_DEVICES_PXE(func) \
+        BOOT_TARGET_DEVICES_DHCP(func) \
+
+#define LOAD_ADDRESS_ENV_SETTINGS \
+        "scriptaddr="         SCRIPT_ADDR_R      "\0" \
+        "pxefile_addr_r="     PXEFILE_ADDR_R     "\0" \
+        "fdt_addr_r="         FDT_ADDR_R         "\0" \
+        "kernel_addr_r="      KERNEL_ADDR_R      "\0" \
+        "kernel_comp_addr_r=" KERNEL_COMP_ADDR_R "\0" \
+        "kernel_comp_size="   KERNEL_COMP_SIZE   "\0" \
+        "ramdisk_addr_r="     RAMDISK_ADDR_R     "\0" \
+
+#include <config_distro_bootcmd.h>
+
+#define CONFIG_EXTRA_ENV_SETTINGS \
+        LOAD_ADDRESS_ENV_SETTINGS \
+        "fdtfile=" CONFIG_DEFAULT_FDT_FILE "\0" \
+        "console=ttyS2,115200n8\0" \
+        BOOTENV
+
+#endif /* __CONFIG_AM642_SOLIDRUN_H */
-- 
2.35.3

