From ffed3a738643ba56300351fe87987e5ebd0ac92d Mon Sep 17 00:00:00 2001
From: Alvaro-Karsz <alvaro.karsz@solid-run.com>
Date: Tue, 19 Oct 2021 10:46:55 +0300
Subject: [PATCH] Select and enable a 25MHz clock for PHY during late init

---
 .../solidrun/am64x_solidrun/am64x_solidrun.c  | 44 +++++++++++++++++++
 1 file changed, 44 insertions(+)

diff --git a/board/solidrun/am64x_solidrun/am64x_solidrun.c b/board/solidrun/am64x_solidrun/am64x_solidrun.c
index fda39a73..ca160604 100644
--- a/board/solidrun/am64x_solidrun/am64x_solidrun.c
+++ b/board/solidrun/am64x_solidrun/am64x_solidrun.c
@@ -152,6 +152,12 @@ static void setup_serial(void)
 #define PHY3_RESET_SET_ADDR   0x00600040
 #define PHY3_RESET_DATA_ADDR  0x0060003C
 
+#define PHY_CLK_MUX_ADDR      0x000F4274
+#define CTRLMMR_LOCK2_KICK0   0x43009008
+#define CTRLMMR_LOCK2_KICK1   0x4300900C
+#define CTRLMMR_LOCK_KEY0     0x68EF3490
+#define CTRLMMR_LOCK_KEY1     0xD172BC5A
+#define CTRLMMR_CLKOUT_CTRL   0x43008010
 
 
 
@@ -186,9 +192,47 @@ void releaseResetPhy(int gpioNum, u32 muxAddr, u32 dirAddr, u32 setAddr, u32 dat
 	writel(val, dataAddr);
 }
 
+/*set PHY clock frequency and select clkout function in MUX*/
+void setClockPhy(void)
+{
+	u32 muxClkoutValue = 0x00010005,
+	    val = 0;
+
+
+	/*release the write lock on partition 2 registers*/
+	writel(CTRLMMR_LOCK_KEY0, CTRLMMR_LOCK2_KICK0);
+        writel(CTRLMMR_LOCK_KEY1, CTRLMMR_LOCK2_KICK1);
+
+
+	/*calculate value to write into the control register*/
+
+	/* CTRLMMR_CLKOUT_CTRL register layout:
+	 *
+	 * 0     CLK_SEL (0 - 50MHz, 1 - 25MHz)
+	 * 1-3   RESERVED
+	 * 4     CLK_EN
+	 * 5-31  RESERVED
+	 * */
+
+	val |= 1;//set CLK_SEL bit
+
+	val |= (1 << 4); //set CLK_EN bit
+
+	/*write the value into the control register*/
+	writel(val, CTRLMMR_CLKOUT_CTRL);
+
+
+	/*select CLKOUT0 function in mux*/
+	writel(muxClkoutValue, PHY_CLK_MUX_ADDR);
+}
+
+
 void initPhy(void)
 {
 
+	/*init PHY clock*/
+	setClockPhy();
+
 	/*release the reset line for the first PHY*/
 	releaseResetPhy(PHY1_RESET_GPIO_NUM, PHY1_RESET_MUX_ADDR, PHY1_RESET_DIR_ADDR, PHY1_RESET_SET_ADDR, PHY1_RESET_DATA_ADDR);
 
-- 
2.25.1

