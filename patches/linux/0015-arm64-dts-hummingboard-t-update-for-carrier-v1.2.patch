From a159df46e6c05edbe02329ab57a3dfcf37773027 Mon Sep 17 00:00:00 2001
From: Josua Mayer <josua@solid-run.com>
Date: Mon, 12 Jun 2023 17:31:55 +0300
Subject: [PATCH 15/15] arm64: dts: hummingboard-t: update for carrier v1.2

v1.2 fixes PCI-E & USB-3.1 (exclusive) on the 2x M.2 connectors, respectively.

Signed-off-by: Josua Mayer <josua@solid-run.com>
---
 .../boot/dts/ti/k3-am642-hummingboard-t.dts   | 179 ++++++------------
 1 file changed, 57 insertions(+), 122 deletions(-)

diff --git a/arch/arm64/boot/dts/ti/k3-am642-hummingboard-t.dts b/arch/arm64/boot/dts/ti/k3-am642-hummingboard-t.dts
index 6db74b53017f..f35e895bb4b6 100644
--- a/arch/arm64/boot/dts/ti/k3-am642-hummingboard-t.dts
+++ b/arch/arm64/boot/dts/ti/k3-am642-hummingboard-t.dts
@@ -16,18 +16,11 @@
 #include <dt-bindings/phy/phy.h>
 
 /*
- * choose either USB-3.1 or PCI-E
- * 1: USB-3.1
- * 0: PCI-E
+ * choose either PCI-E (M1) or USB-3.1 (M2):
+ * - PHY_TYPE_PCIE
+ * - PHY_TYPE_USB3
  */
-#define SERDES0_USB3 1
-
-/*
- * route to either connectors M1 or M2
- * 1: M1
- * 0: M2
- */
-#define SERDES0_M1 1
+#define SERDES0_PHY_TYPE PHY_TYPE_USB3
 
 / {
 	model = "SolidRun AM6442 HummingBoard-T";
@@ -46,30 +39,6 @@ aliases {
 		mmc1 = &sdhci1;
 	};
 
-	clk_pcie_m1: clock-pcie-m1 {
-		compatible = "fixed-clock";
-		clock-frequency = <100000000>;
-		clock-output-names = "pcie_busclk_m1";
-		gpios = <&main_gpio1 16 GPIO_ACTIVE_LOW>;
-		#clock-cells = <0>;
-	};
-
-	clk_pcie_m2: clock-pcie-m2 {
-		compatible = "fixed-clock";
-		clock-frequency = <100000000>;
-		clock-output-names = "pcie_busclk_m2";
-		gpios = <&main_gpio1 14 GPIO_ACTIVE_LOW>;
-		#clock-cells = <0>;
-	};
-
-	clk_pcie_soc: clock-pcie-soc {
-		compatible = "fixed-clock";
-		clock-frequency = <100000000>;
-		clock-output-names = "pcie_refclk";
-		gpios = <&main_gpio1 8 GPIO_ACTIVE_LOW>;
-		#clock-cells = <0>;
-	};
-
 	/* PRU Ethernet Controller (should be in dtsi) */
 	icssg1_eth: icssg1-eth {
 		status = "disabled";
@@ -170,12 +139,12 @@ regulator-m2-3v3 {
 		regulator-max-microvolt = <3300000>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&regulator_pcie_3v3_pins_default>;
-		gpio = <&main_gpio1 31 GPIO_ACTIVE_HIGH>;
+		gpio = <&main_gpio1 17 GPIO_ACTIVE_HIGH>;
 		enable-active-high;
 		regulator-always-on;
 	};
 
-	/* gpio shared between efuse supply (VPP_1V8) & pcie clock generator supply */
+	/* only for programming efuses (VPP_1V8) */
 	regulator-vpp-1v8 {
 		compatible = "regulator-fixed";
 		regulator-name = "vpp-1v8";
@@ -185,9 +154,6 @@ regulator-vpp-1v8 {
 		pinctrl-0 = <&regulator_vpp_1v8_pins_default>;
 		gpio = <&main_gpio1 78 GPIO_ACTIVE_HIGH>;
 		enable-active-high;
-
-		/* enable by default for pcie clock generator ... */
-		regulator-always-on;
 	};
 
 	vdd_mmc0: regulator-vdd-mmc0 {
@@ -210,6 +176,29 @@ secure_ddr: optee@9e800000 {
 			no-map;
 		};
 	};
+
+	serdes_mux: serdes-mux {
+		compatible = "gpio-mux";
+		#mux-control-cells = <0>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&serdes_mux_pins_default>;
+
+		/*
+		 * Mux has 2 IOs:
+		 * - select: 0 = USB-3 (M2); 1 = PCIE (M1)
+		 * - shutdown: 0 = active; 1 = disabled (high impedance)
+		 */
+		mux-gpios = <&main_gpio1 40 GPIO_ACTIVE_HIGH>, <&main_gpio1 41 GPIO_ACTIVE_HIGH>;
+
+#if SERDES0_PHY_TYPE == PHY_TYPE_PCIE
+		idle-state = <1>;
+#elif SERDES0_PHY_TYPE == PHY_TYPE_USB3
+		idle-state = <0>;
+#else
+		/* default disabled */
+		idle-state = <2>;
+#endif
+	};
 };
 
 &cpsw3g {
@@ -398,25 +387,6 @@ m2_pcie_clkreq {
 		input;
 		line-name = "m2-pcie-clkreq";
 	};
-
-	serdes_mux_sel {
-		gpio-hog;
-		/* carrier has pull-down */
-		gpios = <40 GPIO_ACTIVE_HIGH>;
-#if SERDES0_M1
-		output-high; /* asserted */
-#else /* M2 */
-		output-low; /* deasserted */
-#endif
-		line-name = "serdes-mux-sel";
-	};
-
-	serdes_mux_en {
-		gpio-hog;
-		gpios = <41 GPIO_ACTIVE_LOW>;
-		output-high; /* asserted */
-		line-name = "serdes-mux-en";
-	};
 };
 
 &main_i2c0 {
@@ -450,18 +420,6 @@ som_eeprom: eeprom@50 {
 		pagesize = <8>;
 	};
 
-	/* Carrier */
-	pcie_clock_generator: pi6cfgl401b@68 {
-		status = "okay";
-		compatible = "pericom,pi6cfgl401b";
-		reg = <0x68>;
-		/*
-		 * TODO: address depend on SADR pin (floating)
-		 * - 0 = 0x68
-		 * - 1 = 0x6A
-		 */
-	};
-
 	/* Carrier */
 	charger: bq25713@6a {
 		status = "okay";
@@ -668,7 +626,6 @@ AM64X_IOPAD(0x02a8, PIN_OUTPUT, 0)	/* Pad USB0_DRVVBUS Mux USB0_DRVVBUS */
 
 	mdio0_pins_default: mdio0-pins-default {
 		pinctrl-single,pins = <
-			/* TODO: check pull */
 			AM64X_IOPAD(0x01fc, PIN_OUTPUT, 4)	/* Pad PRG0_PRU1_GPO19 Mux MDIO0_MDC */
 			AM64X_IOPAD(0x01f8, PIN_INPUT, 4)	/* Pad PRG0_PRU1_GPO18 Mux MDIO0_MDIO */
 		>;
@@ -713,22 +670,11 @@ AM64X_IOPAD(0x019c, PIN_OUTPUT, 7)	/* Pad PRG0_PRU0_GPO15 Mux GPIO1_15 */
 			AM64X_IOPAD(0x018c, PIN_INPUT, 7)	/* Pad PRG0_PRU0_GPO11 Mux GPIO1_11 */
 			/* connector M2 CLKREQ0 */
 			AM64X_IOPAD(0x01ec, PIN_INPUT, 7)	/* Pad PRG0_PRU1_GPO15 Mux GPIO1_35 */
-			/* PCIE0_OE, external pull-up on carrier */
-			AM64X_IOPAD(0x0198, PIN_OUTPUT, 7)	/* Pad PRG0_PRU0_GPO14 Mux GPIO1_14 */
-			/* PCIE1_OE, external pull-up on carrier */
-			AM64X_IOPAD(0x0180, PIN_OUTPUT, 7)	/* Pad PRG0_PRU0_GPO8 Mux GPIO1_8 */
-			/* PCIE2_OE, external pull-up on carrier */
-			AM64X_IOPAD(0x01a0, PIN_OUTPUT, 7)	/* Pad PRG0_PRU0_GPO16 Mux GPIO1_16 */
-			/* serdes mux SEL, external pull-down on carrier */
-			AM64X_IOPAD(0x0200, PIN_OUTPUT, 7)	/* Pad PRG0_MDIO0_MDIO Mux GPIO1_40 */
-			/* mux enable */
-			AM64X_IOPAD(0x0204, PIN_OUTPUT, 7)	/* Pad PRG0_MDIO0_MDC Mux GPIO1_41 */
 		>;
 	};
 
 	pru1_mdio0_pins_default: pru1-mdio0-pins-default {
 		pinctrl-single,pins = <
-			/* TODO: check pull */
 			AM64X_IOPAD(0x015c, PIN_OUTPUT, 0)	/* Pad PRG1_MDIO0_MDC Mux PRG1_MDIO0_MDC */
 			AM64X_IOPAD(0x0158, PIN_INPUT, 0)	/* Pad PRG1_MDIO0_MDIO Mux PRG1_MDIO0_MDIO */
 		>;
@@ -768,9 +714,18 @@ AM64X_IOPAD(0x0144, PIN_OUTPUT, 2)	/* Pad PRG1_PRU1_GPO15 Mux RGMII2_TX_CTL */
 		>;
 	};
 
+	serdes_mux_pins_default: serdes-mux-pins-default {
+		pinctrl-single,pins = <
+			/* SEL, 10k pull-down on carrier, 2.2k pullup on SoM */
+			AM64X_IOPAD(0x0200, PIN_OUTPUT, 7)	/* Pad PRG0_MDIO0_MDIO Mux GPIO1_40 */
+			/* EN */
+			AM64X_IOPAD(0x0204, PIN_OUTPUT, 7)	/* Pad PRG0_MDIO0_MDC Mux GPIO1_41 */
+		>;
+	};
+
 	regulator_pcie_3v3_pins_default: regulator-pcie-3v3-pins-default {
 		pinctrl-single,pins = <
-			AM64X_IOPAD(0x01dc, PIN_OUTPUT, 7)	/* Pad PRG0_PRU1_GPO11 Mux GPIO1_31 */
+			AM64X_IOPAD(0x01a4, PIN_OUTPUT, 7)	/* Pad PRG0_PRU0_GPO17 Mux GPIO1_17 */
 		>;
 	};
 
@@ -934,40 +889,29 @@ sh28hs512t@0 {
 	};
 };
 
-#if SERDES0_USB3
-&pcie0_rc {
-	status = "disabled";
-};
-
-&pcie0_ep {
-	status = "disabled";
-};
-#else
 /* Carrier M.2 connector M2 */
 &pcie0_rc {
+#if SERDES0_PHY_TYPE == PHY_TYPE_PCIE
 	status = "okay";
+#else
+	status = "disabled";
+#endif
 	pinctrl-names = "default";
 	pinctrl-0 = <&pcie0_pins_default>;
-	reset-gpios = <&main_gpio1 15 GPIO_ACTIVE_LOW>;
-	phys = <&serdes0_pcie_link>;
+	reset-gpios = <&main_gpio1 15 GPIO_ACTIVE_HIGH>;
+	phys = <&serdes0_link>;
 	phy-names = "pcie-phy";
 	num-lanes = <1>;
-#if SERDES0_M1
-	clocks = <&clk_pcie_soc>, <&clk_pcie_m1>;
-	clock-names = "pcie_refclk", "pcie_busclk";
-#else
-	clocks = <&clk_pcie_soc>, <&clk_pcie_m2>;
-	clock-names = "pcie_refclk", "pcie_busclk";
-#endif
+	mux-controls = <&serdes_mux>;
+	mux-control-names = "serdes";
 };
 
 &pcie0_ep {
 	status = "disabled";
-	phys = <&serdes0_pcie_link>;
+	phys = <&serdes0_link>;
 	phy-names = "pcie-phy";
 	num-lanes = <1>;
 };
-#endif
 
 /* eMMC */
 /* SoM */
@@ -1010,22 +954,13 @@ &serdes0 {
 	 */
 	 status = "okay";
 
-#if SERDES0_USB3
-	serdes0_usb_link: phy@0 {
-		status = "okay";
-		reg = <0>;
-		cdns,num-lanes = <1>;
-		#phy-cells = <0>;
-		cdns,phy-type = <PHY_TYPE_USB3>;
-		resets = <&serdes_wiz0 1>;
-	};
-#else /* PCIE */
-	serdes0_pcie_link: phy@0 {
+#if SERDES0_PHY_TYPE
+	serdes0_link: phy@0 {
 		status = "okay";
 		reg = <0>;
 		cdns,num-lanes = <1>;
 		#phy-cells = <0>;
-		cdns,phy-type = <PHY_TYPE_PCIE>;
+		cdns,phy-type = <SERDES0_PHY_TYPE>;
 		resets = <&serdes_wiz0 1>;
 	};
 #endif
@@ -1033,10 +968,10 @@ serdes0_pcie_link: phy@0 {
 
 /* Carrier, because mux is on carrier */
 &serdes_ln_ctrl {
-#if SERDES0_USB3
-	idle-states = <AM64_SERDES0_LANE0_USB>;
-#else
+#if SERDES0_PHY_TYPE == PHY_TYPE_PCIE
 	idle-states = <AM64_SERDES0_LANE0_PCIE0>;
+#elif SERDES0_PHY_TYPE == PHY_TYPE_USB3
+	idle-states = <AM64_SERDES0_LANE0_USB>;
 #endif
 };
 
@@ -1048,7 +983,7 @@ &tscadc0 {
 &usbss0 {
 	status = "okay";
 	ti,vbus-divider;
-#if !SERDES0_USB3
+#if SERDES0_PHY_TYPE != PHY_TYPE_USB3
 	ti,usb2-only;
 #endif
 };
@@ -1060,9 +995,9 @@ &usb0 {
 	dr_mode = "host";
 	pinctrl-names = "default";
 	pinctrl-0 = <&main_usb0_pins_default>;
-#if SERDES0_USB3
+#if SERDES0_PHY_TYPE == PHY_TYPE_USB3
 	maximum-speed = "super-speed";
-	phys = <&serdes0_usb_link>;
+	phys = <&serdes0_link>;
 	phy-names = "cdns3,usb3-phy";
 #else
 	maximum-speed = "high-speed";
-- 
2.35.3

