From f20f8d9efce62fa734743e9e3ea1c9d8bb2ce8df Mon Sep 17 00:00:00 2001
From: Alvaro-Karsz <alvaro.karsz@solid-run.com>
Date: Thu, 14 Oct 2021 15:25:22 +0300
Subject: [PATCH] Bring Up Eth0 interface

---
 arch/arm64/boot/dts/ti/am642-solidrun.dts    | 12 +++++++++---
 arch/arm64/configs/am64xx-solidrun_defconfig | 18 ++++++++++--------
 2 files changed, 19 insertions(+), 11 deletions(-)

diff --git a/arch/arm64/boot/dts/ti/am642-solidrun.dts b/arch/arm64/boot/dts/ti/am642-solidrun.dts
index e8dcc6453..97ebba8d7 100644
--- a/arch/arm64/boot/dts/ti/am642-solidrun.dts
+++ b/arch/arm64/boot/dts/ti/am642-solidrun.dts
@@ -10,6 +10,7 @@
 #include <dt-bindings/leds/common.h>
 #include <dt-bindings/gpio/gpio.h>
 #include <dt-bindings/net/ti-dp83867.h>
+#include <dt-bindings/net/ti-dp83869.h>
 #include "k3-am642.dtsi"
 
 / {
@@ -379,6 +380,7 @@ AM64X_IOPAD(0x0130, PIN_OUTPUT, 4) /* (W14) PRG1_PRU1_GPO10.RGMII1_TD2 */
 			AM64X_IOPAD(0x014c, PIN_OUTPUT, 4) /* (AA14) PRG1_PRU1_GPO17.RGMII1_TD3 */
 			AM64X_IOPAD(0x00e0, PIN_OUTPUT, 4) /* (U14) PRG1_PRU0_GPO10.RGMII1_TXC */
 			AM64X_IOPAD(0x00dc, PIN_OUTPUT, 4) /* (U15) PRG1_PRU0_GPO9.RGMII1_TX_CTL */
+			AM64X_IOPAD(0x0154, PIN_OUTPUT | PIN_INPUT, 7)/*  (V12) - PHY RESET*/
 		>;
 	};
 
@@ -633,10 +635,14 @@ &cpsw_port2 {
 };
 
 &cpsw3g_mdio {
+	reset-gpios =  <&main_gpio0 84 GPIO_ACTIVE_LOW>;
+	reset-delay-us = <2>;
+
 	cpsw3g_phy0: ethernet-phy@0 {
 		reg = <0>;
-		ti,rx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
-		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
+	        tx-internal-delay-ps = <2000>;
+		ti,op-mode = <DP83869_RGMII_COPPER_ETHERNET>;
+		ti,fifo-depth = <DP83869_PHYCR_FIFO_DEPTH_4_B_NIB>;
 	};
 };
 
@@ -774,7 +780,7 @@ &icssg1_mdio {
 	pinctrl-names = "default";
 	pinctrl-0 = <&icssg1_mdio1_pins_default>;
 
-	icssg1_phy1: ethernet-phy@0 {
+	icssg1_phy1: ethernet-phy@f {
 		reg = <0xf>;
 	};
 };
diff --git a/arch/arm64/configs/am64xx-solidrun_defconfig b/arch/arm64/configs/am64xx-solidrun_defconfig
index ee16892a3..5c24059ee 100644
--- a/arch/arm64/configs/am64xx-solidrun_defconfig
+++ b/arch/arm64/configs/am64xx-solidrun_defconfig
@@ -2168,7 +2168,7 @@ CONFIG_VIRTIO_NET=y
 # end of Distributed Switch Architecture drivers
 
 CONFIG_ETHERNET=y
-CONFIG_MDIO=m
+CONFIG_MDIO=y
 # CONFIG_NET_VENDOR_3COM is not set
 # CONFIG_NET_VENDOR_ADAPTEC is not set
 # CONFIG_NET_VENDOR_AGERE is not set
@@ -2336,19 +2336,19 @@ CONFIG_AQUANTIA_PHY=y
 # CONFIG_INTEL_XWAY_PHY is not set
 # CONFIG_LSI_ET1011C_PHY is not set
 CONFIG_MARVELL_PHY=y
-CONFIG_MARVELL_10G_PHY=m
+CONFIG_MARVELL_10G_PHY=y
 CONFIG_MICREL_PHY=y
-CONFIG_MICROCHIP_PHY=m
+CONFIG_MICROCHIP_PHY=y
 # CONFIG_MICROCHIP_T1_PHY is not set
 CONFIG_MICROSEMI_PHY=y
 # CONFIG_NATIONAL_PHY is not set
 # CONFIG_NXP_TJA11XX_PHY is not set
 CONFIG_AT803X_PHY=y
 # CONFIG_QSEMI_PHY is not set
-CONFIG_REALTEK_PHY=m
+CONFIG_REALTEK_PHY=y
 # CONFIG_RENESAS_PHY is not set
 CONFIG_ROCKCHIP_PHY=y
-CONFIG_SMSC_PHY=m
+CONFIG_SMSC_PHY=y
 # CONFIG_STE10XP is not set
 # CONFIG_TERANETICS_PHY is not set
 # CONFIG_DP83822_PHY is not set
@@ -3215,7 +3215,7 @@ CONFIG_W1=m
 CONFIG_POWER_RESET=y
 # CONFIG_POWER_RESET_BRCMSTB is not set
 # CONFIG_POWER_RESET_GPIO is not set
-# CONFIG_POWER_RESET_GPIO_RESTART is not set
+CONFIG_POWER_RESET_GPIO_RESTART=y
 # CONFIG_POWER_RESET_LTC2952 is not set
 # CONFIG_POWER_RESET_RESTART is not set
 CONFIG_POWER_RESET_XGENE=y
@@ -6455,13 +6455,15 @@ CONFIG_GENERIC_PHY=y
 CONFIG_GENERIC_PHY_MIPI_DPHY=y
 CONFIG_PHY_XGENE=y
 CONFIG_PHY_CAN_TRANSCEIVER=m
+CONFIG_PHY_MIXEL_LVDS=y
+CONFIG_PHY_MIXEL_LVDS_COMBO=y
 # CONFIG_BCM_KONA_USB2_PHY is not set
 CONFIG_PHY_CADENCE_TORRENT=y
-CONFIG_PHY_CADENCE_DPHY=m
+CONFIG_PHY_CADENCE_DPHY=y
 CONFIG_PHY_CADENCE_SIERRA=y
 # CONFIG_PHY_CADENCE_SALVO is not set
 # CONFIG_PHY_FSL_IMX8MQ_USB is not set
-CONFIG_PHY_MIXEL_MIPI_DPHY=m
+CONFIG_PHY_MIXEL_MIPI_DPHY=y
 # CONFIG_PHY_PXA_28NM_HSIC is not set
 # CONFIG_PHY_PXA_28NM_USB2 is not set
 # CONFIG_PHY_CPCAP_USB is not set
-- 
2.25.1

