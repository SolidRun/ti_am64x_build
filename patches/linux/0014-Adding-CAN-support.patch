From d4c0f359c65dc4ffe5b1ad6d031271ca2fb9a597 Mon Sep 17 00:00:00 2001
From: Moaath Abusalh <moaath.abusalh@solid-run.com>
Date: Mon, 1 Aug 2022 08:04:39 +0300
Subject: [PATCH] Adding CAN support

---
 arch/arm64/boot/dts/ti/am642-solidrun.dts    |  24 ++---
 arch/arm64/configs/am64xx-solidrun_defconfig | 102 ++++++++-----------
 2 files changed, 52 insertions(+), 74 deletions(-)

diff --git a/arch/arm64/boot/dts/ti/am642-solidrun.dts b/arch/arm64/boot/dts/ti/am642-solidrun.dts
index da88c5761..4c99957c5 100644
--- a/arch/arm64/boot/dts/ti/am642-solidrun.dts
+++ b/arch/arm64/boot/dts/ti/am642-solidrun.dts
@@ -165,20 +165,6 @@ led-0 {
 		};
 	};
 
-	transceiver1: can-phy0 {
-		compatible = "ti,tcan1042";
-		#phy-cells = <0>;
-		max-bitrate = <5000000>;
-		standby-gpios = <&exp1 8 GPIO_ACTIVE_HIGH>;
-	};
-
-	transceiver2: can-phy1 {
-		compatible = "ti,tcan1042";
-		#phy-cells = <0>;
-		max-bitrate = <5000000>;
-		standby-gpios = <&exp1 9 GPIO_ACTIVE_HIGH>;
-	};
-
 	icssg1_eth: icssg1-eth {
 		compatible = "ti,am642-icssg-prueth";
 		pinctrl-names = "default";
@@ -767,13 +753,19 @@ flash@0{
 &main_mcan0 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&main_mcan0_pins_default>;
-	phys = <&transceiver1>;
+    transceiver1{
+        status = "okay";
+        max-bitrate = <5000000>;
+    };
 };
 
 &main_mcan1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&main_mcan1_pins_default>;
-	phys = <&transceiver2>;
+	transceiver2{
+        status = "okay";
+        max-bitrate = <5000000>;
+    };
 };
 
 &icssg0_mdio {
diff --git a/arch/arm64/configs/am64xx-solidrun_defconfig b/arch/arm64/configs/am64xx-solidrun_defconfig
index 690377bd7..3e58fac1e 100644
--- a/arch/arm64/configs/am64xx-solidrun_defconfig
+++ b/arch/arm64/configs/am64xx-solidrun_defconfig
@@ -243,12 +243,12 @@ CONFIG_SYSTEM_DATA_VERIFICATION=y
 CONFIG_ARM64=y
 CONFIG_64BIT=y
 CONFIG_MMU=y
-CONFIG_ARM64_PAGE_SHIFT=16
-CONFIG_ARM64_CONT_PTE_SHIFT=5
-CONFIG_ARM64_CONT_PMD_SHIFT=5
-CONFIG_ARCH_MMAP_RND_BITS_MIN=14
-CONFIG_ARCH_MMAP_RND_BITS_MAX=29
-CONFIG_ARCH_MMAP_RND_COMPAT_BITS_MIN=7
+CONFIG_ARM64_PAGE_SHIFT=12
+CONFIG_ARM64_CONT_PTE_SHIFT=4
+CONFIG_ARM64_CONT_PMD_SHIFT=4
+CONFIG_ARCH_MMAP_RND_BITS_MIN=18
+CONFIG_ARCH_MMAP_RND_BITS_MAX=33
+CONFIG_ARCH_MMAP_RND_COMPAT_BITS_MIN=11
 CONFIG_ARCH_MMAP_RND_COMPAT_BITS_MAX=16
 CONFIG_STACKTRACE_SUPPORT=y
 CONFIG_ILLEGAL_POINTER_VALUE=0xdead000000000000
@@ -266,7 +266,7 @@ CONFIG_ARCH_ENABLE_MEMORY_HOTREMOVE=y
 CONFIG_SMP=y
 CONFIG_KERNEL_MODE_NEON=y
 CONFIG_FIX_EARLYCON_MEM=y
-CONFIG_PGTABLE_LEVELS=3
+CONFIG_PGTABLE_LEVELS=4
 CONFIG_ARCH_SUPPORTS_UPROBES=y
 CONFIG_ARCH_PROC_KCORE_TEXT=y
 
@@ -356,12 +356,10 @@ CONFIG_SOCIONEXT_SYNQUACER_PREITS=y
 CONFIG_ARM64_4K_PAGES=y
 # CONFIG_ARM64_16K_PAGES is not set
 # CONFIG_ARM64_64K_PAGES is not set
-# CONFIG_ARM64_VA_BITS_42 is not set
+# CONFIG_ARM64_VA_BITS_39 is not set
 CONFIG_ARM64_VA_BITS_48=y
-# CONFIG_ARM64_VA_BITS_52 is not set
 CONFIG_ARM64_VA_BITS=48
 CONFIG_ARM64_PA_BITS_48=y
-# CONFIG_ARM64_PA_BITS_52 is not set
 CONFIG_ARM64_PA_BITS=48
 # CONFIG_CPU_BIG_ENDIAN is not set
 CONFIG_CPU_LITTLE_ENDIAN=y
@@ -385,6 +383,7 @@ CONFIG_ARCH_FLATMEM_ENABLE=y
 CONFIG_HAVE_ARCH_PFN_VALID=y
 CONFIG_HW_PERF_EVENTS=y
 CONFIG_SYS_SUPPORTS_HUGETLBFS=y
+CONFIG_ARCH_WANT_HUGE_PMD_SHARE=y
 CONFIG_ARCH_HAS_CACHE_LINE_SIZE=y
 CONFIG_ARCH_ENABLE_SPLIT_PMD_PTLOCK=y
 # CONFIG_PARAVIRT is not set
@@ -394,7 +393,7 @@ CONFIG_KEXEC_FILE=y
 # CONFIG_KEXEC_SIG is not set
 # CONFIG_CRASH_DUMP is not set
 # CONFIG_XEN is not set
-CONFIG_FORCE_MAX_ZONEORDER=14
+CONFIG_FORCE_MAX_ZONEORDER=11
 CONFIG_UNMAP_KERNEL_AT_EL0=y
 CONFIG_RODATA_FULL_DEFAULT_ENABLED=y
 # CONFIG_ARM64_SW_TTBR0_PAN is not set
@@ -665,9 +664,9 @@ CONFIG_HAVE_MOD_ARCH_SPECIFIC=y
 CONFIG_MODULES_USE_ELF_RELA=y
 CONFIG_ARCH_HAS_ELF_RANDOMIZE=y
 CONFIG_HAVE_ARCH_MMAP_RND_BITS=y
-CONFIG_ARCH_MMAP_RND_BITS=14
+CONFIG_ARCH_MMAP_RND_BITS=18
 CONFIG_HAVE_ARCH_MMAP_RND_COMPAT_BITS=y
-CONFIG_ARCH_MMAP_RND_COMPAT_BITS=7
+CONFIG_ARCH_MMAP_RND_COMPAT_BITS=11
 CONFIG_ARCH_WANT_DEFAULT_TOPDOWN_MMAP_LAYOUT=y
 CONFIG_CLONE_BACKWARDS=y
 CONFIG_OLD_SIGSUSPEND3=y
@@ -1292,10 +1291,10 @@ CONFIG_NET_FLOW_LIMIT=y
 # end of Networking options
 
 # CONFIG_HAMRADIO is not set
-CONFIG_CAN=m
-CONFIG_CAN_RAW=m
-CONFIG_CAN_BCM=m
-CONFIG_CAN_GW=m
+CONFIG_CAN=y
+CONFIG_CAN_RAW=y
+CONFIG_CAN_BCM=y
+CONFIG_CAN_GW=y
 # CONFIG_CAN_J1939 is not set
 # CONFIG_CAN_ISOTP is not set
 
@@ -1305,7 +1304,7 @@ CONFIG_CAN_GW=m
 # CONFIG_CAN_VCAN is not set
 # CONFIG_CAN_VXCAN is not set
 # CONFIG_CAN_SLCAN is not set
-CONFIG_CAN_DEV=m
+CONFIG_CAN_DEV=y
 CONFIG_CAN_CALC_BITTIMING=y
 CONFIG_CAN_FLEXCAN=m
 # CONFIG_CAN_GRCAN is not set
@@ -1316,8 +1315,8 @@ CONFIG_CAN_C_CAN_PLATFORM=m
 # CONFIG_CAN_C_CAN_PCI is not set
 # CONFIG_CAN_CC770 is not set
 # CONFIG_CAN_IFI_CANFD is not set
-CONFIG_CAN_M_CAN=m
-CONFIG_CAN_M_CAN_PLATFORM=m
+CONFIG_CAN_M_CAN=y
+CONFIG_CAN_M_CAN_PLATFORM=y
 # CONFIG_CAN_M_CAN_TCAN4X5X is not set
 # CONFIG_CAN_PEAK_PCIEFD is not set
 # CONFIG_CAN_SJA1000 is not set
@@ -1363,17 +1362,17 @@ CONFIG_BT_LEDS=y
 #
 # Bluetooth device drivers
 #
-CONFIG_BT_INTEL=y
-CONFIG_BT_BCM=y
-CONFIG_BT_RTL=y
-CONFIG_BT_QCA=y
-CONFIG_BT_HCIBTUSB=y
+CONFIG_BT_INTEL=m
+CONFIG_BT_BCM=m
+CONFIG_BT_RTL=m
+CONFIG_BT_QCA=m
+CONFIG_BT_HCIBTUSB=m
 CONFIG_BT_HCIBTUSB_AUTOSUSPEND=y
 CONFIG_BT_HCIBTUSB_BCM=y
 # CONFIG_BT_HCIBTUSB_MTK is not set
 CONFIG_BT_HCIBTUSB_RTL=y
 # CONFIG_BT_HCIBTSDIO is not set
-CONFIG_BT_HCIUART=y
+CONFIG_BT_HCIUART=m
 CONFIG_BT_HCIUART_SERDEV=y
 CONFIG_BT_HCIUART_H4=y
 # CONFIG_BT_HCIUART_NOKIA is not set
@@ -2168,7 +2167,7 @@ CONFIG_VIRTIO_NET=y
 # end of Distributed Switch Architecture drivers
 
 CONFIG_ETHERNET=y
-CONFIG_MDIO=y
+CONFIG_MDIO=m
 # CONFIG_NET_VENDOR_3COM is not set
 # CONFIG_NET_VENDOR_ADAPTEC is not set
 # CONFIG_NET_VENDOR_AGERE is not set
@@ -2389,10 +2388,6 @@ CONFIG_MDIO_BUS_MUX_MMIOREG=y
 
 # CONFIG_PPP is not set
 # CONFIG_SLIP is not set
-
-#
-# Host-side USB support is needed for USB Network Adapter support
-#
 CONFIG_USB_NET_DRIVERS=y
 # CONFIG_USB_CATC is not set
 # CONFIG_USB_KAWETH is not set
@@ -2403,7 +2398,7 @@ CONFIG_USB_LAN78XX=m
 CONFIG_USB_USBNET=y
 CONFIG_USB_NET_AX8817X=m
 CONFIG_USB_NET_AX88179_178A=m
-CONFIG_USB_NET_CDCETHER=m
+CONFIG_USB_NET_CDCETHER=y
 CONFIG_USB_NET_CDC_EEM=m
 CONFIG_USB_NET_CDC_NCM=y
 # CONFIG_USB_NET_HUAWEI_CDC_NCM is not set
@@ -2581,6 +2576,7 @@ CONFIG_WLAN_VENDOR_QUANTENNA=y
 # Enable WiMAX (Networking options) to see the WiMAX drivers
 #
 # CONFIG_WAN is not set
+# CONFIG_VMXNET3 is not set
 # CONFIG_NETDEVSIM is not set
 CONFIG_NET_FAILOVER=y
 # CONFIG_ISDN is not set
@@ -3867,11 +3863,11 @@ CONFIG_RADIO_ADAPTERS=y
 # CONFIG_RADIO_SAA7706H is not set
 # CONFIG_RADIO_TEF6862 is not set
 # CONFIG_RADIO_WL1273 is not set
-CONFIG_VIDEOBUF2_CORE=m
-CONFIG_VIDEOBUF2_V4L2=m
-CONFIG_VIDEOBUF2_MEMOPS=m
+CONFIG_VIDEOBUF2_CORE=y
+CONFIG_VIDEOBUF2_V4L2=y
+CONFIG_VIDEOBUF2_MEMOPS=y
 CONFIG_VIDEOBUF2_DMA_CONTIG=m
-CONFIG_VIDEOBUF2_VMALLOC=m
+CONFIG_VIDEOBUF2_VMALLOC=y
 CONFIG_V4L_PLATFORM_DRIVERS=y
 # CONFIG_VIDEO_CAFE_CCIC is not set
 CONFIG_VIDEO_CADENCE=y
@@ -4590,7 +4586,7 @@ CONFIG_SND_PCM_ELD=y
 CONFIG_SND_PCM_IEC958=y
 CONFIG_SND_DMAENGINE_PCM=y
 CONFIG_SND_HWDEP=m
-CONFIG_SND_RAWMIDI=m
+CONFIG_SND_RAWMIDI=y
 CONFIG_SND_JACK=y
 CONFIG_SND_JACK_INPUT_DEV=y
 # CONFIG_SND_OSSEMUL is not set
@@ -5022,13 +5018,6 @@ CONFIG_HID_MULTITOUCH=m
 CONFIG_USB_HID=y
 # CONFIG_HID_PID is not set
 # CONFIG_USB_HIDDEV is not set
-
-#
-# USB HID Boot Protocol drivers
-#
-# CONFIG_USB_KBD is not set
-# CONFIG_USB_MOUSE is not set
-# end of USB HID Boot Protocol drivers
 # end of USB HID support
 
 #
@@ -5043,11 +5032,11 @@ CONFIG_USB_SUPPORT=y
 CONFIG_USB_COMMON=y
 # CONFIG_USB_LED_TRIG is not set
 CONFIG_USB_ULPI_BUS=y
-#CONFIG_USB_CONN_GPIO=m
+# CONFIG_USB_CONN_GPIO is not set
 CONFIG_USB_ARCH_HAS_HCD=y
 CONFIG_USB=y
 CONFIG_USB_PCI=y
-#CONFIG_USB_ANNOUNCE_NEW_DEVICES=y
+# CONFIG_USB_ANNOUNCE_NEW_DEVICES is not set
 
 #
 # Miscellaneous USB options
@@ -5056,8 +5045,7 @@ CONFIG_USB_DEFAULT_PERSIST=y
 # CONFIG_USB_FEW_INIT_RETRIES is not set
 # CONFIG_USB_DYNAMIC_MINORS is not set
 CONFIG_USB_OTG=y
-CONFIG_USB_OTG_WHITELIST=y
-#CONFIG_USB_OTG_PRODUCTLIST=y
+# CONFIG_USB_OTG_PRODUCTLIST is not set
 # CONFIG_USB_OTG_DISABLE_EXTERNAL_HUB is not set
 # CONFIG_USB_OTG_FSM is not set
 # CONFIG_USB_LEDS_TRIGGER_USBPORT is not set
@@ -5085,7 +5073,6 @@ CONFIG_USB_EHCI_HCD_PLATFORM=y
 # CONFIG_USB_MAX3421_HCD is not set
 CONFIG_USB_OHCI_HCD=y
 CONFIG_USB_OHCI_HCD_PCI=y
-# CONFIG_USB_OHCI_HCD_SSB is not set
 CONFIG_USB_OHCI_HCD_PLATFORM=y
 # CONFIG_USB_UHCI_HCD is not set
 # CONFIG_USB_SL811_HCD is not set
@@ -5150,6 +5137,7 @@ CONFIG_USB_MUSB_DUAL_ROLE=y
 #
 # CONFIG_MUSB_PIO_ONLY is not set
 CONFIG_USB_DWC3=y
+# CONFIG_USB_DWC3_ULPI is not set
 # CONFIG_USB_DWC3_HOST is not set
 # CONFIG_USB_DWC3_GADGET is not set
 CONFIG_USB_DWC3_DUAL_ROLE=y
@@ -5247,6 +5235,7 @@ CONFIG_USB_SERIAL_OPTION=y
 # CONFIG_USB_LD is not set
 # CONFIG_USB_TRANCEVIBRATOR is not set
 # CONFIG_USB_IOWARRIOR is not set
+# CONFIG_USB_TEST is not set
 CONFIG_USB_EHSET_TEST_FIXTURE=y
 # CONFIG_USB_ISIGHTFW is not set
 # CONFIG_USB_YUREX is not set
@@ -5284,7 +5273,7 @@ CONFIG_USB_GADGET_STORAGE_NUM_BUFFERS=32
 # CONFIG_USB_PXA27X is not set
 # CONFIG_USB_MV_UDC is not set
 # CONFIG_USB_MV_U3D is not set
-#CONFIG_USB_SNP_UDC_PLAT=y
+# CONFIG_USB_SNP_UDC_PLAT is not set
 # CONFIG_USB_M66592 is not set
 # CONFIG_USB_BDC_UDC is not set
 # CONFIG_USB_AMD5536UDC is not set
@@ -5392,7 +5381,7 @@ CONFIG_TYPEC_HD3SS3220=m
 # CONFIG_TYPEC_DP_ALTMODE is not set
 # end of USB Type-C Alternate Mode drivers
 
-CONFIG_USB_ROLE_SWITCH=m
+CONFIG_USB_ROLE_SWITCH=y
 CONFIG_MMC=y
 CONFIG_PWRSEQ_EMMC=y
 # CONFIG_PWRSEQ_SD8787 is not set
@@ -6438,7 +6427,7 @@ CONFIG_ARM_GIC_V3_ITS_PCI=y
 CONFIG_PARTITION_PERCPU=y
 CONFIG_TI_SCI_INTR_IRQCHIP=y
 CONFIG_TI_SCI_INTA_IRQCHIP=y
-CONFIG_TI_PRUSS_INTC=m
+CONFIG_TI_PRUSS_INTC=y
 # end of IRQ chip support
 
 # CONFIG_IPACK_BUS is not set
@@ -6455,8 +6444,6 @@ CONFIG_GENERIC_PHY=y
 CONFIG_GENERIC_PHY_MIPI_DPHY=y
 CONFIG_PHY_XGENE=y
 CONFIG_PHY_CAN_TRANSCEIVER=m
-CONFIG_PHY_MIXEL_LVDS=y
-CONFIG_PHY_MIXEL_LVDS_COMBO=y
 # CONFIG_BCM_KONA_USB2_PHY is not set
 CONFIG_PHY_CADENCE_TORRENT=y
 CONFIG_PHY_CADENCE_DPHY=y
@@ -6469,9 +6456,12 @@ CONFIG_PHY_MIXEL_MIPI_DPHY=y
 # CONFIG_PHY_CPCAP_USB is not set
 # CONFIG_PHY_MAPPHONE_MDM6600 is not set
 # CONFIG_PHY_OCELOT_SERDES is not set
+# CONFIG_PHY_QCOM_USB_HS is not set
+# CONFIG_PHY_QCOM_USB_HSIC is not set
 CONFIG_PHY_AM654_SERDES=y
 CONFIG_PHY_J721E_WIZ=y
 CONFIG_OMAP_USB2=m
+# CONFIG_PHY_TUSB1210 is not set
 CONFIG_PHY_TI_GMII_SEL=y
 # end of PHY Subsystem
 
@@ -7436,7 +7426,3 @@ CONFIG_RUNTIME_TESTING_MENU=y
 CONFIG_MEMTEST=y
 # end of Kernel Testing and Coverage
 # end of Kernel hacking
-#
-#
-#
-#
-- 
2.25.1

